<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>An Introduction to Modern Authentication and Authorization</title>

		<meta name="description" content="Theory and hands-on examples to do web based Authentication and Authorization">
		<meta name="author" content="Lars Kåre Skjørestad">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/simple.css" id="theme">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">

	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

				<!-- Front page -->
				<section style="text-align: left;">
					<h1>Modern A&A</h1>
					<h4>Authentication and Authorization</br>
					oAuth2 and OpenID Connect (OICD)</h4>
				</p>
					<small>An simple introduction to a endless complex topic</small>
					<p>
						<small><a href="https://loop.equinor.com" target="_blank">Equinor</a></Equinor> <font style="color:red;">#AppSec</font> community</a></small>
					</p>
				</section>


<!-- Objectives part-->
				<section>
					<section>
						<h1>Objectives</h1>
					</section>

					<section>
						<h3>Workshop objectives </h3>
						<blockquote style="color:dodgerblue">De-mystify, build confidence and prepare for further exploration of A&A</blockquote>
						<ul style="font-size: 80%;">
							<li>Give an introduction to basics modern web A&A</li>
							<li>Explore Spec and Azure Implementation</li>
							<li>Hands-on coding with a few A&A scenarios </li>
							<li>Insight into threats and best current practices (BCP) for security</li>
						</ul>
					</section>
				</section>

<!-- Outlines part-->
				<section>
					<section>
						<h1>Workshop Outline</h1>
					</section>
					<section style="text-align: left;">
						<h3>Workshop outline</h3>
						<ul>
							<li>What problem are we trying to solve?</li>
							<li>Practicalities</li>
							<li>The basics of A&A</li>
							<li>Exercises (8+1)</li>
							<Sharing>Raw flows, add authentication to web app, using frameworks & libraries, accessing 3rd party api, refresh tokens, single page web app (SPA), protecting web api's
							<li>Deploy application to the Cloud (using Radix)</li>
						</ul>
					</section>
				</section>


<!-- A day in the life of a modern app-->
				<section>
						<section>
							<h3>A day in the life of</h3>
							<h2 style="color:red">sMailandStuff</h2>
							<Small>The mature web Swiss Army Knife</Small>
							<p></p>
							<a href="https://webapp-smailandstuff-production.playground.radix.equinor.com/"
							target="_blank">sMailandStuff</a> on Raidx
						</section>

						<section>
							<h3>The players</h3>
							<img src="./graphics/export/actors.jpg" width="75%">
						</section>
				</section>
			
<!-- The Delegation problem-->
				<section>
							
					<section>
						<h1>The delegation problem</h1>
						<small style="color:blue">Giving access to 3rd parties</small>
						<p></p><small>API's are a driving force</small>
					</section>

					<section>
						<h3>Old style A&A</h3>
						<small>Impersonating, Direct Authenticating</small><p></p>
						<img src="./graphics/export/my_super_app_old.jpg" width="75%">
					</section>
					<section>
						<h3>Old style A&A</h3>
						<small>Impersonating, Direct Authenticating</small>
						<table>
							<tr>
								<td><img src="./graphics/export/my_super_app_old.jpg" ></td>
								<td style=" vertical-align: top;">
									<ul>
										<li>Store id/password for each service</li>
										<li>No way to revoke access</li>
										<li>Access not time limited</li>
										<li>Full access only - not granular</li>
									</ul>
								</td>
							</tr>
						</table>
					</section>


					<section>
						<h3>New Style A&A</h3>
						<small>Delegating</small><p></p>
						<img src="./graphics/export/my_super_app_new.jpg" width="75%">
					</section>
					<section>
						<h3>New style A&A</h3>
						<table>
							<tr>
								<td><img src="./graphics/export/my_super_app_new.jpg" ></td>
								<td style=" vertical-align: top;">
									<ul>
										<li>id/password not stored on client</li>
										<li>Access can be revoked</li>
										<li>Access can be time limited</li>
										<li>Access can be granular</li>
										<li>Access is delegated from resource owner to client</li>
									</ul>
								</td>
							</tr>
						</table>
					</section>
				</section>

<!-- Disclaimer part-->
				<section>
					<h1>Disclaimer</h1>
					<p>The more I learn about the topic the more I realize how complex it is. I am not an expert.
						 Very rarely is the answer black and white. Context is important.
						 I assume that quite a few of you have experience, insight and knowledge to share.
						 Please share! Sharing is caring!</p>
					<p style="color:blue; font-size: 70%;">Code examples are not production quality - they are happy-path</p>
				</section>

<!-- The practicalities & useful links part -->
				<section>
					<section>
						<h1>Practicalities</h1>
						<h3><a href="https://equinor.slack.com/archives/CQUQN8QQL" target="_blank">#appsec-authentication-and-authorization-course</a></h3> on Slack
					</section>
					<section>
							<h1>Useful links</h1>
							<small>
								<ul>
									<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/" target="_blank">Microsoft Identity Platform</a></li>
									<li><a href="https://oauth.net/2/" target="_blank">oAuth2.net</a></li>
									<li><a href="https://tools.ietf.org/html/rfc6749" target="_blank">The OAuth Authorization Framework (rfc 6749)</a></li>
									<li><a href="https://openid.net/connect/" target="_blank">OpenID Connect</a></li>
								</ul>
							</small>
						</section>
						<section>
							<h3>Run-time environments -</br> known differences</h3>
							<ul>
								<li>Examples uses Unix path notation "./src". </br>In Windows this will be "src/</li>
								<li>Scripts in course code, like <span style="color: blue">npm start</span> uses Linux notation. Must be changed for Windows environments</li>
							</ul>
						</section>
				</section>

<!-- The basic of A&A part 1-->
				<section>
					<section>
						<h1>The basics of A&A</h1>
						<h4>Part #1</h4>
					</section>
					<section>
						<h3>Authentication vs. Authorization</h3>
						<p><span style="color:red">Authentication</span> =</br>is the mechanism to verify the identity of a user</p>
						<p><span style="color:red">Authorization</span> = </br>is the mechanism to verify access to a resource</p>
					</section>
					<section>
						<h3>oAuth2</h3>
						<blockquote style="font-size: 75%">
						The OAuth 2.0 authorization framework enables a
						</br> third-party application to obtain limited access to an HTTP service,
						</br></br>either on behalf of a resource owner
						</br>by orchestrating an approval interaction between the resource owner and the HTTP service
						</br></br>or by allowing the third-party application to obtain access on its own behalf.</blockquote>
						<small><a style="font-size: 200%;color: red" href="https://tools.ietf.org/html/rfc6749" target="_blank">oAuth2</a> is a <strong>delegation protocol</strong>, a means of giving someone who controls a resource the capability to delegate access to the resource on their behalf (without impersonating).</small>
					</section>

					<section>
						<h3>oAuth2 vs OpenID Connect</h3>
						<ul>
							<li>oAuth is for delegation, the goal is to access api's</li>
							<li>OpenID Connect is an identify layer on top of oAuth</li>
							<ul>
								<li>Defines user authentication metadata</li>
								<li>Can control authentication</li>
								<li>Supports federation</li>
							</ul>
						</ul>
					</section>

					<section style="font-size: 75%">
						<h3>oAuth2 Roles/Actors</h3>
						<p><div style="color:blue">resource owner</div>
						An entity capable of granting access to a protected resource.
						When the resource owner is a person, it is referred to as an
						end-user.
						</p>
						<p><div style="color:blue">resource server</div>
						The server hosting the protected resources, capable of accepting
						and responding to protected resource requests using access tokens.
						</p>
						<p><div style="color:blue">client</div>
						An application making protected resource requests on behalf of the
						resource owner and with its authorization.  The term "client" does
						not imply any particular implementation characteristics (e.g.,
						whether the application executes on a server, a desktop, or other
						devices).
						</p>
						<p><div style="color:blue"> authorization server</div>				
						The server issuing access tokens to the client after successfully
						authenticating the resource owner and obtaining authorization.
						</p>
					</section>
					<section>
						<h3>Actors</h3>
						<img src="./graphics/export/actors.jpg" width="75%">
					</section>
					<section>
						<h4><a href="https://tools.ietf.org/html/rfc6749#section-1.2"
							target="_blank">Abstract protocol flow (rfc6749)</a></h4>
						<pre>
+--------+                               +---------------+
|        |--(A)- Authorization Request ->|   Resource    |
|        |                               |     Owner     |
|        |<-(B)-- Authorization Grant ---|               |
|        |                               +---------------+
|        |
|        |                               +---------------+
|        |--(C)-- Authorization Grant -->| Authorization |
| Client |                               |     Server    |
|        |<-(D)----- Access Token -------|               |
|        |                               +---------------+
|        |
|        |                               +---------------+
|        |--(E)----- Access Token ------>|    Resource   |
|        |                               |     Server    |
|        |<-(F)--- Protected Resource ---|               |
+--------+                               +---------------+
						</pre>
					</section>
					<section>
						<h4 style="text-align: left;">Abstract protocol flow</h4>
						<pre style="font-size: 35%; text-align: left;">
+-- <span style="color:red">Resource</span> --+ +-- <span style="color: blue;">Client</span> -- + +- <span style="color:bluegreen">Authorization</span> -+ +--<span style="color:violet"> Resource</span> --+
+    Owner     + +             + +     Server      + +   Server     +
+--------------+ +-------------+ +-----------------+ +--------------+
     -                   -                -                     -
     |  <span style="color:blue">(A)Client request</span>|                |                     |
     |      <span style="color:blue">Authorization</span>|                |                     |
     |<------------------|                |                     |
     |- - - - - - - - - - - - - - - - - ->|                     |
     |                   |                |                     |
     |<span style="color:red">(B) Resource Owner</span> |                |                     |
     |<span style="color:red">Grants authorization</span>                |                     |
     |----------------------------------->|                     |
     |                   |<- - - - - - - -|                     |
     |                   |                |                     |
     |                   |<span style="color:blue">(C) Client send</span> |                     |
     |                   |  <span style="color:blue">Authorization</span> |                     |
     |                   |          <span style="color:blue">grant</span> |                     | 
     |                   |--------------->|                     |
     |                   |                |                     |
     |                   | <span style="color:bluegreen">(D)Autorization</span>|                     |
     |                   |    <span style="color:bluegreen">server sends</span>|                     |
     |                   |    <span style="color:bluegreen">access token</span>|                     |
     |                   |<---------------|                     |
     |                   |                |                     |
     |                   |<span style="color:blue">(E)Client sends</span> |                     |
     |                   |<span style="color:blue">Access Token</span>    |                     |
     |                   |------------------------------------->|
     |                   |                |                     |
     |                   |                |<span style="color:violet">(F)Protected resource</span>|
     |                   |                |       <span style="color:violet">sends resource</span>|
     |                   |<-------------------------------------|
     |                   |                |                     |
     -                   -                -                     -                                   
						</pre>
					</section>

					<section>
						<h2>What oAuth is and is not</h2>
						<ul style="font-size: 80%;">
							<li>Is not defined outside HTTP</li>
							<li>Is "requiring" TLS</li>
							<li>Is not an authentication protocol</li>
							<li>Is not processing authorization</li>
							<li>Is not defining user-to-user delegation</li>
							<li>Is not defining a token format</li>
							<li>Is not defining crypto methods</li>
							<li>Is not a single protocol - </br>it supports multiple use cases -</br> it's a protocol for protocols</li>
						</ul>
					</section>

					<section>
						<h3>Obtaining authorization - </br>the oauth Dance</h3>
						<blockquote style="font-size: 80%;">To request an access token, the client obtains authorization from the resource owner.  The authorization is expressed in the form of an authorization grant, which the client uses to request the access token.  OAuth defines four grant types: <span style="color:red">authorization code, implicit, resource owner password credentials</span>, and <span style="color:red">client credentials</span>.  It also provides an extension mechanism for defining additional grant types.</blockquote>
				</section>

				<section>
					<h2>It's about getting tokens</h2>
					<ul>
						<li>Access token (to provide access)</li>
						<li>ID token (to prove identity)</li>
						<li>Refresh token</li>
					</ul>
					<p>More on tokens later....</p>
				</section>

				<section>
					<h3><a href="https://tools.ietf.org/html/rfc6749#section-4.1"
						target="_blank">Authorization Code Grant</a></h3>
						<small><a href="https://tools.ietf.org/html/rfc6749#section-4.1" target="_blank">rfc6749 #4.1</a></small>
					<pre style="font-size: 40%;">

+----------+
| Resource |
|   Owner  |
|          |
+----------+
 ^
 |
(B)
+----|-----+          Client Identifier      +---------------+
|         -+----(A)-- & Redirection URI ---->|               |
|  User-   |                                 | Authorization |
|  Agent  -+----(B)-- User authenticates --->|     Server    |
|          |                                 |               |
|         -+----(C)-- Authorization Code ---<|               |
+-|----|---+                                 +---------------+
|    |                                           ^      v
(A)  (C)                                         |      |
|    |                                           |      |
^    v                                           |      |
+---------+                                      |      |
|         |>---(D)-- Authorization Code ---------'      |
|  Client |          & Redirection URI                  |
|         |                                             |
|         |<---(E)----- Access Token -------------------'
+---------+       (w/ Optional Refresh Token)			
					</pre>
				</section>
				<section>
					<h3>Authorization Code Grant</h3>
					<img src="./graphics/export/oauth_code_flow.jpg" width="75%">
				</section>

				<section>
					<h3>Authorization Code Grant</h3>
					<table>
						<tr>
							<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
							<td style=" vertical-align: top;">
								<p>-1-</p>
								Client via user agent - initiates
							</td>
						</tr>
					</table>
				</section>

				<section>
						<h3>Authorization Code Grant</h3>
						<table>
							<tr>
								<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
								<td style=" vertical-align: top;">
									<p>-2-</p>
									<span style="font-size: 70%;">
									GET /authorize? </br>
									client_id=client </br>
									&scope=(optional) </br>
									&reponse_type=code </br>
									&state=1234
									&redirect_uri=
									https://app/callback
									</span>
								</td>
							</tr>
						</table>
				</section>

				<section>
						<h3>Authorization Code Grant</h3>
						<table>
							<tr>
								<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
								<td style=" vertical-align: top;">
									<p>-3-</p>
									Authentication is handed over to authentication server
								</td>
							</tr>
						</table>
				</section>

				<section>
						<h3>Authorization Code Grant</h3>
						<table>
							<tr>
								<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
								<td style=" vertical-align: top;">
									<p>-4-</p>
									<span style="font-size: 70%;">
									303 redirect
									https://app/callback? </br>
									code=o-t-c</br>
									&state=1234</br>		
									</span>
								</td>
							</tr>
						</table>
				</section>

				<section>
						<h3>Authorization Code Grant</h3>
						<table>
							<tr>
								<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
								<td style=" vertical-align: top;">
									<p>-5-</p>
									<span style="font-size: 70%;">
									POST /token
									grant_type=authorization_code</br>
									&client_id=</br>
									&client_secret=</br>
									&code=</br>
									&redirect_uri=</br>
									</span>
								</td>
							</tr>
						</table>
				</section>

				<section>
						<h3>Authorization Code Grant</h3>
						<table>
							<tr>
								<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
								<td style=" vertical-align: top;">
									<p>-6-</p>
									<span style="font-size: 70%;">
									{</br>
											"access_token":"2YotnFZFEjr1zCsicMWpAA",
											"token_type":"example",
											"expires_in":3600,
											"refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
											"token_type":"Bearer"
										</br>}
									</span>
								</td>
							</tr>
						</table>
				</section>


				<section>
						<h2>OpenID Connect (<a href="https://openid.net/connect/" target="_blank">OICD</a>)</h2>
						<ul style="font-size: 80%;">
							<li><span style="color:red">Identity</span> layer built on-top of oAuth2</li>
							<li>Defines user authentication meta data</li>
							<li>Can control authentication</li>
							<lI>Enables federation</lI><p></p>
						</ul>
						<table style="font-size: 80%;">
							<thead>
								<tr>
									<td>oAuth2 term</td>
									<td>OICD term</td>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>Resouce owner</td>
									<td>User</td>
								</tr>
								<tr>
									<td>Client</td>
									<td>Relying party</td>
								</tr>
								<tr>
									<td>Authorisation server, Protected resource</td>
									<td>Identity provider</td>
								</tr>
							</tbody>
						</table>
					</section>
	
					<section>
							<h3>OpenID Connect Code Flow</h3>
							<table>
								<tr>
									<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
									<td style=" vertical-align: top;">
										<p>-2-</p>
										<span style="font-size: 70%;">
										GET /authorize? </br>
										client_id=client </br>
										&scope=read+<span style="color:red">openid</span> </br>
										&reponse_type=code </br>
										&state=1234
										&redirect_uri=
										https://app/callback
										</span>
									</td>
								</tr>
							</table>
					</section>


					<section>
							<h3>OpenID Connect Code Flow</h3>
							<table>
								<tr>
									<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
									<td style=" vertical-align: top;">
										<p>-3-</p>
										Authentication is handed over to authentication server
									</td>
								</tr>
							</table>
					</section>

					<section>
							<h3>OpenID Connect Code Flow</h3>
							<table>
								<tr>
									<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
									<td style=" vertical-align: top;">
										<p>-4-</p>
										<span style="font-size: 70%;">
										303 redirect
										https://app/callback? </br>
										code=o-t-c</br>
										&state=1234</br>		
										</span>
									</td>
								</tr>
							</table>
					</section>

					<section>
							<h3>OpenID Connect Code Flow</h3>
							<table>
								<tr>
									<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
									<td style=" vertical-align: top;">
										<p>-5-</p>
										<span style="font-size: 70%;">
										POST /token 
										grant_type=authorization_code</br>
										&client_id=</br>
										&client_secret=</br>
										&code=</br>
										&redirect_uri=</br>
										</span>
									</td>
								</tr>
							</table>
					</section>

					<section>
							<h3>OpenID Connect Code Flow</h3>
							<table>
								<tr>
									<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
									<td style=" vertical-align: top;">
										<p>-6-</p>
										<span style="font-size: 70%;">
										{</br>
												"access_token":"ey2YotnFZFEjr1zCsicMWpAA",</br>
												"token_type":"example",</br>
												<span style="color:red">"id_token": "eynndj3nn77hs7Hhjhjh"</span> ,</br>
												"expires_in":3600,</br>
												"refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",</br>
												"token_type":"Bearer"
											</br>}
										</span>
									</td>
								</tr>
							</table>
					</section>



						<section>
						<h2>OpenID Connect (OICD)</h2>
						<ul style="font-size: 70%";">
							<li>New <span style="color:red">IDToken</span> received upon successful authentication</li>
							<li>Access tokens are not proof of authentication. They are not intended for client - rather the protected resource</li>
							<li>IDToken's can be given to client along with Access tokens</li>
							<li>IDTokens' are signed JWT tokens.</li>
							<li>ID tokens contains claims such as</li>
								<ul>
									<li>iss - issuer of the token</li>
									<li>sub - subject - user id from identity provider</li>
									<li>aud - audience - id for relying party</li>
									<li>exp - expiration time stamp</li>
								</ul>
							<li>For the Azure implementation, more documentation on the <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-protocols-oidc" target="_blank">Microsoft Identity Platform</a> doc pages.
							Explore attributes such as "prompt", "login_hint", "response_mode"</li>
						</ul>
					</section>


					<section>
						<h3>OAuth Flows that we have not covered</h3>
						<ul>
							<li>Client credentials</br>
								Typically service to service in protected environment
							</li>
							<li>Resource Owner Password Credentials</br>
								High trust envionments where the resource owner trusts it's credentials to the client
							</li>
							<li>(Implicit grant will be covered later)</li>
						</ul>
					</section>

					<section>
						<h1>Please note ...</h1>
						<ul>
							<li>Use Azure AD v2 endpoints whenever possible, V1 is about to be deprecated</li>
							<li>Be aware of doc and v1 vs. v2 (it's easy to read the wrong one)</li>
						</ul>
					</section>
				</section>

<!-- Exercise 1 -->
				<section>
					<section>
						<h1>Exercise - 1</h1>
						<h2>Raw Authorization Code Grant</h2>
					</section>	

					<section>
						<h2>Exercise Outline</h2>
						<ul style="font-size: 80%;">
							<li>Clone github repository</li>
							<li>Investigate <a href="https://tools.ietf.org/html/rfc6749#section-4.1" target="_blank">spec</a> and doc on <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow" target="_blank">Azure</a></li>
							<li>Register app object in <a href="https://portal.azure.com" target="_blank">Azure AD</a></li>
							<li>Set-up postman</li>
							<li>Request authorization code</li>
							<li>Request an access token</li>
							<li>Explore tokens</li>
							<li>Use access token</li>
						</ul>
					</section>
					<section>
						<h2>Clone github repository</h2>
						<p><a style="font-size: 70%;" href"https://github.com/larskaare/WebAuthAuthorAndOtherCreatures" target="_blank">https://github.com/larskaare/WebAuthAuthorAndOtherCreatures</a></p>
						<pre><code class="hljs" style="font-size: 80%;" >git clone git@github.com:larskaare/WebAuthAuthorAndOtherCreatures.git</code></pre>
					</section>
					<section>
						<h3>Register application in Azure AD</h3>
						<ul style="font-size: 80%;">
							<li>Navigate to <a href="https://portal.azure.com" target="_blank">portal.azure.com</a> and find Azure Active Directory</li>
							<li>Select App registrations</br>(App registration vs. Enterprise Applications</li>
							<li>Register new application</li>
								<ul>
									<li>Activate "Application developer role" in "Privileged Identiy Management"</li>
									<li><span style="color:red">Name</span>: (inital)-(aatest) or something else</li>
									<li><span style="color:red">Type</span>: Single tenant</li>
									<li><span style="color:red">Redirect uri</span>: http://localhost/auth</li>
								</ul>
							<li>Explore options for the new app registration</li>
						</ul>
					</section>

					<section>
						<h3>Set-up Postman</h3>
						<ul>
							<li>Start Postman</li>
							<li>Import "Azure AD v2.0 Protocols.postman_collection.json" from "./ex-1" folder</li>
						</ul>
					</section>

					<section>
						<h3>Request authorization code</h3>
						<ul style="font-size: 70%;">
							<li>Select "Oauth 2.0 Authorization Code Flow" -> GET Autorization request</li>					
							<li>Explore "endpoints" for application registration (Azure Portal)"</li>
							<li>Copy and substitute oAuth2 Authorization endpoint v2 to GET request</li>
							<li>Copy "client_id" to GET request parameter</li>
							<li>Change "redirect_url" to "http://localhost/auth" for GET request parameter</li>
							<li>Look at scope for GET request</li>
							<li>Copy GET request to clip board and execute from web browser </br> (the code is use once within seconds)</li>
							<li>Copy authorization code from "code" parameter in request</li>
							<li>Explore changig "scope", "resonse_mode" and "redirect uri" for GET request</li>
							<li>Why do we have to execute request in web browser?</li>
							<li>Discuss security considerations</li>
							<li><span style="color:red">Good practice</span> : remove the localhost redirect from production applications</li>
						</ul>
					</section>
					
					<section>
						<h3>Request an access token</h3>
						<ul style="font-size: 70%;">
								<li>Select "POST - Token Request - Auth Code" from Postman collection</li>
								<li>Copy and substitute oAuth2 Token endpoint v2 to POST request</li>
								<li>Define client secret for application in Azure Portal</li>
								<li>Update body for POST request <span style="color:red">client_id, redirect_uri, client_secret, code</span><br>(code is from GET request)</li>		
								<li>Send POST request</li>
								<li>(Handle SSL "issues")</li>
								<li>Explore response</li>
								<li>Discuss security considerations (SSL, secrets, certificates, public vs. confidential client)</li>
							</ul>
					</section>

					<section>
						<h3>Explore tokens</h3>
						<ul style="font-size: 70%;">
							<li>Use <a href="https://jwt.ms" target="_blank">https://jwt.ms</a> to explore tokens</li>
							<li>Explore tokens, claims and dates</br> (access_token, refresh_token, id_token)</li>
							<li>Experiment with scope param
								</br>Scope profile+email will put "more" info into id_token
								</br>Scope offline_access will add refresh_token
							</li>
							<li>Discuss claims, optional claims, application manifest and <b>token config</b> in AD app object </li>
							<li>Discuss security considerations (token validation, token storage)</li>
							<li><span style="color:red">Good practice</span>: Don't uses access tokens as authentication. Access tokens are for the protected resource </li>
						</ul>
					</section>

					<section>
						<h3>If time </br>- more flows to try with Postman</h3>
						<ul>
							<li>OpenID Connect Code Flow?</li>
							<li>oAuth2 Implicit Flow?</li>
							<li>OpenID Connect Implicit Flow</li>
							<li>oAuth2 Client Credentials</li>
						</ul>
					</section>
				</section>

<!-- Exercise 2 :  -->					
				
				<section>
						<section>
							<h1>Exercise 2</h1>
							<h4>Web applicaton</h4>
							<h3>Getting an access token</h3>
						</section>
	
						<section>
							<h3>Outline</h3>
							<ul>		
								<li>Environment Variables</li>
								<li>Prepare environment (ex-2)</li>
								<li>Explore the web app code</li>
								<li>Config, run and explore app</li>
								<li>Secrets</li>
								<li>Staging environments and logging</li>
							</ul>
						</section>

						<section>
							<h3>Environment variables</h3>
							<ul style="font-size: 70%;">
								<li>Define environment variables
									<code class="hljs">$ export PORT=3000</code>
									<code class="hljs">$ export CLIENT_SECRET=[your secret]</code>
									<code class="hljs">$ export CLIENT_ID=[your client id]</code>
									<code class="hljs">$ export NODE_ENV=[production | developement | debug]</code>
								</li>
								<li><span style="color:red">Good practice</span>: 
									Move config into config files, potentially .env files (that are defined in .gitignore and/or kept outside version control, stored outside git)	
								</li>
							</ul>
						</section>

						<section>
								<h3>Preparing the environment</h3>
								<ul>
									<li>Navigate to the <span style="color: blue">./ex-2</span> directory</li>
									<li>Install dependencies
										<code class="hljs">$ npm install</code>
									</li>
								</ul>
						</section>

						<section>
								<h3>Explore the code</h3>
								<ul>
									<li>Explore endpoints in <a href="https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview" target="_blank">Azure</a> for application object</li>
									<li>Explore application config objects </br>(authServer, client, scope) in  <span style="color:blue">./app.js</span></li>
									<li>Explore authentication code in <span style="color:blue">./app.js</span></li>
									<ul>
										<li>/authorize</li>
										<li>/callback</li>
									</ul>
									<li>Header uses basic auth for client credentials (remember to base64 encode)</li>
									</br>
									<li>Explore routing/views in application</li>
								</ul>
						</section>

						<section>
								<h3>Config, Run and Explore </h3>
								<img src="./graphics/export/actors.jpg" 
								style="
									position: absolute;
									top: 100px;
									right:0px;
									width:20%;
									display:inline-block
								">
								<ul style="font-size: 80%;">
									<li>Configure the <span style="color:blue">authServer</span> object in app.js</li>
									<li>Explore the <span style="color:blue">client</span> object in app.js</li>
									<li>Configure environment variables</li>
									<li>Run web application
										<code class="hljs">$ npm start</code>
									</li>
									<li>Fix error?</li>
									<li>Explore <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow" target="_blank">spec</a>, alter scope and other params</li>
									<li>Explore what <a href="https://myapps.microsoft.com/" target="_blank">consent</a> you have given to apps on Azure AD. </br> Test revoking for test app.</li>
									<li>Explore running the app with NODE_ENV=debug</li>
									<li><span style="color:red">Bad practice?</span>: 
										Extracting things like "given_name" from Access Token to display in client (as done in exercise code)</li>
								</ul>
								</ul>
						</section>

						<section>
							<h3>Secrets</h3>
							<ul>
								<li><span style="color:red">Good practice</span>: 
									Keep secrets outside version control!	
								</li>
								<li><span style="color:red">Ok practice</span>: 
									Inject secrets as environment variables	
								</li>
								<li><span style="color:red">Good practice</span>: 
									Store secrets in keyvaults (explore if managed identities are available (MSI)) 	
								</li>
							</ul>
						</section>

						<section>
							<h3>Staging environments - logging </h3>
							<ul>
								<li>Explore logging logic in <span style="color:blue">./app.js</span></li>
								<li>Different logging level dependent on environment (debug, development, production)</li>
								<li><span style="color:red">Good practice</span>: 
									Have a strategy for log purpose and transports (why you log, where you store/not store)	
								</li>
								<li><span style="color:red">Good practice</span>: 
									Be conscious of what you put in log files!!	
								</li>
							</ul>
						</section>
				</section>

<!-- The basic of A&A - part 2 -->
<section>
	<section>
		<h1>The basics of A&A</h1>
		<h4>Part #2</h4>
	</section>


	<section>
		<h2>Let's disucss a few elements</h2>
	</section>


	<section>
			<h3>Clients</h3>
			<ul>
				<li>Clients are either confidential or public
					<ul>
						<li><span style="color:red">Confidential:</span> Clients capable of maintaining the confidentiality of their credentials. (Web apps)</li>
						<li><span style="color:red">Public:</span> Clients incapable of maintaining the confidentiality of their credentials (SPA, Native) </li>
					</ul>
				</li>
				<li>Clients provide a redirection URI</li>
			</ul>
		</section>
	
		<section>
			<h3>Protocol Endpoints</h3>
			<ul>
				<li><span style="color:red">Authorization endpoint:</span> used by client to get authorization from resource owner </li>
				<li><span style="color:red">Token endpoint:</span> used by client to exchange authorization grant for an access token</li>
				<li>There may be other endpoints based on actual implementation</li>
		</section>
		
		<section>
			<h3>Channels - Interaction between actors</h3>
			<ul>
				<li><span style="color:red">Front-channel</span>: Communication between two parties through an intermediate (the web browser)</li>
				<li><span style="color:red">Back-channel</span>: Communication happening outside the view of the resource owner and the user agent (like browser)</li>					
			</ul>

		</section>


		<section>
			<h2>Tokens</h2>
			<ul>
				<li>Token type: How it can be used</li>
				<ul>
					<li>Use it as is, bearer type (Access token) (<a href="https://tools.ietf.org/html/rfc6750" target="_blank">RFC6750</a>)  </li>
					<li>Use it, but prove that I own it </br>(Proof Of Possession)(No wide implementation)</li>
				</ul>
				<li>Token format: Encoding</li>
				<ul>
					<li>By value (token contains all values)</li>
					<li>By reference (pointer to more information)</li>
				</ul>
				<li>Token purpose: Who is it for?</br>(Client, Authorisation Server, Resource Server</li>
			</ul>
		</section>

		<section>
			<h3>Access token</h3>
			<ul style="font-size: 80%;">
				<li>Access tokens are credentials used to access protected resources.  An access token is a string representing an authorization issued to the	client.  The string is usually opaque to the client.  Tokens represent specific scopes and durations of access, granted by the resource owner, and enforced by the resource server and authorization server.</span>
				 </li>
				 <li>By reference or value, for <span style="color:red">resource server</span>, bearer type</li>
			</ul>						
		</section>

		<section>
				<h3>Refresh token</h3>
				<ul style="font-size: 80%;">
					<li>Refresh tokens are credentials used to obtain access tokens.  Refresh tokens are issued to the client by the authorization server and are used to obtain a new access token when the current access token becomes invalid or expires, or to obtain additional access tokens with identical or narrower scope (access tokens may have a shorter lifetime and fewer permissions than authorized by the resource	owner).  Issuing a refresh token is optional at the discretion of the authorization server.  If the authorization server issues a refresh token, it is included when issuing an access token.</span>
					</li>
					 <li>By value, for <span style="color:red">client</span></li>
				</ul>						
		</section>

		<section>
			<h3>ID token</h2>
			<ul style="font-size: 80%;">
				<li>ID tokens are issued to the client to validate that a user is who he/she claims to be and to provide additional
					information about the user.
				</li>
				<li>ID tokens are issued as part of OpenID connect</li>
				 <li>By value, for <span style="color:red">client</span></li>
			</ul>						
	</section>

	<section>
			<h3>Azure AD (AAD) issues JWT tokens (access, id)</h3>
			<small><a href="https://tools.ietf.org/html/rfc7519" target="_blank">JSON Web Token (JWT)(RFC7519)</a></small></br>
			<div style="font-size:40%; text-align: center;">eyJ0eXAiOiJKV1QiLA0KICJhbGciOiJIUzI1NiJ9<span style="color:red">.</span></br>eyJpc3MiOiJqb2UiLA0KICJleHAiOjEzMDA4MTkzODAsDQogImh0dHA6Ly9leGFtcGxlLmNvbS9pc19yb290Ijp0cnVlfQ<span style="color:red">.</span></br>dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk</div>
			<p></p>
			<pre><code class="hljs">
{
"typ": "JWT",
"alg": "HS256"
}.
{
"iss": "joe",
"exp": 1300819380,
}.
[Signature]
			</code> 
			</pre>	
			<small style="font-size: 40%;">Header, Payload with claims and Signature -  based64 encoded</small>

		</section>


		<section>
			<h3>Example ID Token</h3>
			<small>Azure AD ID Token <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/id-tokens" target="_blank">claims</a></small>
			<pre><code class="hljs" style="font-size: 60%;">
{
"typ": "JWT",
"alg": "RS256"
}.{
"aud": "cab2507d-e7d1-46fd-9580-ea7de0cd02ea",
"iss": "https://login.microsoftonline.com/../v2.0",
"exp": 1571657734,
"name": "Jon Doe",
"oid": "..",
"roles": [
"Admin"
],
"sub": "..",
}.[Signature]</code> 
			</pre>	
		</section>

	<section>
		<h3>Scope</h3>
		<ul>
			<li>Defined the scope of access</li>
			<li>Defines permissions given in the access token</li>
			<li>Consentable</li>
			<li>The scope request is configured on the client</li>
			<li>The Scope is requested in the flow</li>
			<li>The Authorization Server determines if scope should be issued</li>
		</ul>
	</section>
	<section>
			<h3>Consent</h3>
			<ul>
				<li>Scope can be consented by (In Azure impl)</li>
				<ul>
					<li>User on on-behalf of self</li> 
					<li>Admin on behalf of organization</li>
				</ul>
				<li>The consent is about delegating the client access to resource server on a users behalf</li>
			</ul>
		</section>


		<section>
			<h3>Token Introspection</h3>
			<ul>
				<li>The process for a protected resource to query the authorization server to verify validity of a oAuth2 token</li>
				<li>An extension to oAuth2 defined in <a href="https://tools.ietf.org/html/rfc7662"
				target="_blank">rfc7662</a></li>
				<li>Getting tokens type by ref and querying for "details"</li>
				<li>Not currently supported by Azure AD
				<a href="https://feedback.azure.com/forums/169401-azure-active-directory/suggestions/18930289-introspection-endpoint-for-azure-active-directory"
				target="_blank">(Improvement request)</a>	
				</li>
			</ul>
		</section>

	
</section>



<!-- Exercise 3 :  -->	
					<section>
							<section>
								<h1>Exercise 3</h1>
								<h3>Scope</h3>
								<small>Consent, Graph explorer, tokens - security, state - session</small>
							</section>

							<section>
									<h3>Outline</h3>
									<ul>
										<li>Explore the MS Graph Explorer</li>
										<li>Discuss Permissions and Consent</li>
										<li>Prepare environment (ex-3)</li>
										<li>Explore the code</li>
										<li>Config, run and explore</li>
										<li>Security considerations - good practices++</li>
									</ul>
							</section>
	
							<section>
								<h3>The MS Graph Explorer</h3>
								<ul>
									<li>Open the <a href="https://developer.microsoft.com/en-us/graph/graph-explorer"
									target="_blank">MS Graph Explorer</a></li>
									<li>Sign in</li>
									<li>Query the <span style="color:blue">/v1.0/me</span> endpoint</li>
									<li>Query the <span style="color:blue">/v1.0/me/memberOf</span> endpoint</li>
									<li>Query the <span style="color:blue">v1.0/me/mailFolders('Inbox')/messages?$select=sender,subject</span> endpoint</li>
									<li>Explore the <a href="https://docs.microsoft.com/nb-no/graph/api/overview?view=graph-rest-1.0" target="_blank">graph api</a> documentation</li>
									<li>Play around with other endpoints, filtering, permissions, consent</li>
								</ul>
							</section>		

							<section>
								<h3>Permissions & Consent</h3>
								<ul style="font-size: 80%;">
									<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-permissions-and-consent" target="_blank">Documentation</a> of Permission and Consent on the MS Identity platform </li>
									<li>Scope = requested permissions</li>
									<li>Delegated permissions, for signed-in-user, user or admin consent</li>
									<li>Application permission, without signed-in-user, admin consent only</li>
									<li>Effective permissions - least privileged between app and user (Example App has User.ReadWriteAll, User has no admin right = Effective rights will be only to update own profile  </li>
									<li>Effective permission for application permission will be the full permission</li>
								</ul>
							</section>

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: blue">./ex-3</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
									</ul>
							</section>

							<section>
									<h3>Explore the code</h3>
									<ul>
										<li>Explore authentication code in <span style="color:blue">./app.js</span></li>
										<li>Adding session management (express-session)</li>
										<li>Adding new route to show mail (/routes/mail.js)</li>
										<li>Adding capabilities to scope (Mail.Read, User.Read)</li>
										<li>Storing access_token in session</li>
										<li>Explore routing/views in application (<span style="color:blue">app.use('/mail', mailRouter);</span>)</li>
									</ul>
							</section>

							<section>
									<h3>Config, Run and Explore </h3>
									<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 150px;
										right:0px;
										width:20%;
										display:inline-block
									">
									<ul>
										<li>Explore the <span style="color:blue">authServer</span> object in app.js</li>
										<li>Explore the <span style="color:blue">client</span> object in app.js</li>
										<li>Configure environment variables</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore the new mail functionality</li>
									</ul>
							</section>


							<section>
									<h3>Security considerations</h3>
									<ul style="font-size: 80%;">
										<li>Access_token storage</li>
										<li>Increase user experience - extend session management to persist user data, refresh tokens??</li>
										<li>Access_token validation - is not happening</li>
										<li><a href="https://tools.ietf.org/html/rfc6819" target="_blank">oAuth2 Threat Model and Security Considerations</a></li>
										<li><a href="https://tools.ietf.org/html/draft-ietf-oauth-security-topics" target="_blank"> OAuth Security Topics</a></li>
										<li><span style="color:red">Good practice</span>: 
											It's a lot of hard work to get A&A done properly - USE a Framework!
										</li>
										<li><span style="color:red">Good practice</span>: 
											Protocols (and Frameworks) does not guarantee security, Developers Do
										</li>
										<li><span style="color:red">Good practice</span>: 
											Only request the minimum scope, dynamically - not all at once
										</li>
									</ul>
								</section>
						</section>
<!-- Exercise 4 :  -->						
					<section>
							<section>
								<h1>Exercise 4</h1>
								<h3>Use frameworks!</h3>
							</section>

							<section>
									<h3>Outline</h3>
									<ul>
										<li>Explore available frameworks for oAuth2</li>
										<li>Prepare environment (ex-4)</li>
										<li>Explore the code</li>
										<li>Config, run and explore</li>
										<li>Font-end vs. back-end communication channels</li>
										<li>Session handling</li>
										<li>Security considerations - good practices++</li>
									</ul>
							</section>

							<section>
								<h3>Frameworks</h3>
								<ul>
									<li>Explore the <span style="color:blue">quickstart</span> of the application object</li>
									<li>Explore <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/reference-v2-libraries"
										target="_blank">Authentication libraries</a> at the MS Identity Platform</li>
									<li>Explore <a href="https://oauth.net/code/"
											target="_blank">Authentication libraries</a> at oauth.net</li>
									<li>Explore <a href="https://github.com/AzureADQuickStarts"
												target="_blank">the Azure AD Quick Starts</a></li>		
									<li><span style="color:red">Good practice</span>: 
										Use the latest library from Microsoft, MSAL, when available
									</li>	
								</ul>
							</section>

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: blue">./ex-4</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
									</ul>
							</section>

							<section>
									<h3>Explore the code</h3>
									<ul>
										<li>Introducing <a href="http://www.passportjs.org/" target="_blank">passport.js</a></li>
										<li>Introducing <a href="https://github.com/AzureAD/passport-azure-ad" target="_blank">passport-azure-ad</a></li>
										<li>./src/</li>
										<ul>
											<li style="color:blue">app.js</li>
											<li>authutils.js</li>
											<li>logHelper.js</li>
										</ul>
										<li style="color:blue">config/config.js</li>
										<li>./routes/</li>
										<ul>
												<li>index.js</li>
												<li>mail.js</li>
												<li>userinformation.js</li>
											</ul>
									</ul>
							</section>

							<section>
									<h3>Config, Run and Explore </h3>
									<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 150px;
										right:0px;
										width:20%;
										display:inline-block
									">
									<ul>
										<li>Update the AD application object with new <span style="color:blue">redirect url</span></li>
										<li>Configure environment variables</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore the application</li>
										<li>Change "node_env" and observe whats happening to the logging</li>
									</ul>
							</section>

							<section>
								<h3>Font-end vs. back-end com. channels</h3>
								<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 130px;
										right:0px;
										width:30%;
										display:inline-block
									">
								<ul>
									<li>Font-end: Browser (User agent) to</li>
									<ul>
										<li>back-end (localhost:3000/mail,</br> /userinfo)</li>
										<li>Azure AD authentication</li>
									</ul>
									<li>Back-end: Client (Web app) to</li>
									<ul>
										<li>Azure ADd authorize (getting access token)</li>
										<li>Accessing the MS Graph on behalf of user</li>
									</ul>
									<li>A tool like <a href="https://portswigger.net/burp/communitydownload" target="_blank">Burp Community Edition</a>
										could be used to investigate/debug front-end and back-end traffic when on localhost
										<small>Browsers may have different policies on using proxies for localhost</small>
									</li>
								</ul>
								</section>

								<section>
										<h3>Session handling</h3>
										<ul>
											<li>Our web application use express and <a href="https://github.com/expressjs/session" target="_blank">express-session</a> to manage user session</li>
											<li>The session cookie is named connect.sid</li>
											<li>The cookie only stores session id</li>
											<li>The cookie is signed (to detect tampering)</li>
											<li>Session data is stored on the back-end (memory)</li>
											<li>A lesser secure(?) alternative could be to store session data in the cookie</li>
											<li><span style="color:blue">Task:</span> Open the developer tools in the browser and locate the session cookie for our app.
												</br> Alter cookie and observe effect in app </li>
										</ul>
										</section>	

							<section>
									<h3>Security considerations</h3>
									<ul style="font-size: 80%;">
										<li>Access_token storage</li>
										<li>Persistent Session storage (from memory to database?)</li>
										<li>Cookie signing keys</li>
										<li>Cookie stealing</li>
										<li>Access_token is being validated</li>
										<li>Only authenticated users are getting access to end-points (<span style="color:blue">ensureAuthenticated</span>)</li>
											<li><span style="color:red">Good practice</span>: 
											Follow security advices for all frameworks (Example:  
											<a href="https://expressjs.com/en/advanced/best-practice-security.html" target="_blank">Express - Production Best Practices: Security</a>)</li>
											<li><span style="color:red">Good practice</span>: 
												Know your frameworks - it takes time & capacity when complexity is hidden!  
												</li>
										</ul>
								</section>
					</section>

<!-- Exercise 5 :  -->	
					<section>
							<section>
								<h1>Exercise 5</h1>
								<h3>Authorization scenarios</h3>
								<h4>The Application Manifest</h4>
							</section>

							<section>
								<h3>Outline</h3>
									<ul style="font-size: 80%;">
										<li>Prepare environment (ex-5)</li>
										<li>Explore the code</li>
										<li>Config, run and explore</li>
										<li>Scenario 1: Only people with valid account should have access</li>
										<li>Scenario 2: Only defined users/groups should have access</li>
										<li>Scenario 3: Application roles to handele authorisation</li>
										<li>Accessing 3d party api's protected by oauth2</li>
									</ul>
							</section>

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: blue">./ex-5</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
										</ul>
							</section>

							<section>
									<h3>Explore the code</h3>
									<ul>
										<li style="color:blue">src/app.js</li>
											<ul>
												<li>passport.use(....)</br>Creating authInfo object in profile to store relevant claims</li>
											</ul>
											<li style="color:blue">view/userinfo.pug</li>
											<ul>
												<li>Showing information about groups & roles in claim</li>
											</ul></br>
									</ul>
							</section>

							<section>
								<h3>Exploring claims in ID token</h3>
								<pre><code class="hljs">
{...}.
{...
 "name": "Jon Doe",
 "preferred_username": "",
 "roles": [
	"Writer"
 ],
 "groups": ["",""],
}.[Signature]
								</code></pre>
								Explore <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/id-tokens" target="_blank">
								 ID Tokens in MS Identity platform</a> as well as the <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-optional-claims"
								 target="_blank">optional</a> claims (and the new <b>token configuration</b> in the AD app object).
							</section>

							<section>
									<h3>Config, Run and Explore </h3>
									<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 200px;
										right:0px;
										width:20%;
										display:inline-block
									">
									<ul>
										<li>Verify the AD application object <span style="color:blue">redirect url</span></li>
										<li>Configure environment variables</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore the "user information" part of the web application</li>
									</ul>
							</section>

							<section>
								<h3>Scenario 1:</br> Only people with a valid account should have access</h3>
								<ul style="font-size: 80%;">
									<li><span style="color:blue">App Registration (object)</span> vs. <span style="color:blue">Enterprise Application (instance, multi-tentant)</span></li>
									<li>In "Enterprise Applications" (Azure AD) explore the property section for your application</li>
									<ul>
										<li>"Enables for users to sign-in?"</li>
										<li>"User assignment required?"</br>(User must be assigned to be able to sign in)</li>
									</ul>
									<li><span style="color:blue">Sign-in enabled</span> and <span style="color:blue">no user assignment required = available to everyone with valid user account in tenant</li>
								</ul>
								</section>

							<section>
									<h3>Scenario 2:</br> Only defined users/groups should have access</<br></h3>
									<ul style="font-size: 65%;">
										<li>There are several ways to achive this scenario</li>
										<li>1) Managing the App Object</li>
											<ul>
												<li>Set "User assignment" to "Yes" - in App property</li>
												<li>Add users and groups in "Users & Groups" - in App property</li>
											</ul>
										<li>2) Alter application manifest to include security groups</li>
										<ul>
											<li>The <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/reference-app-manifest" target="_blank">Application Manifest</a> defines all the attributes and behavior of an applicaton object</li>
											<li><span style="color:blue">groupMembershipClaims</span> to include <span style="color:blue">"SecurityGroup"</span></li>
											<li>Alter - save - explore "user information part in our web app</li>
											<li>This approach have some limitations (size) </li>
										</ul>
										<li>3) Read information in the Microsoft graph about user & groups 
											This require admin concent for the application and generally gives to much privileges!! Should be avoided</li>
									</ul>
								</section>

								<section>
										<h3>Scenario 3: Application roles</h3>
										<ul style="font-size: 65%;">
											<li>Application roles implement RBAC</li>
											<li>App admins grant permissions to roles, users and groups are assigned to roles</li>
											<li>Define application role in app manifest (<a href="https://docs.microsoft.com/nb-no/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps" target="_blank">doc</a>)
											</br>ID is a self generated GUID and must be unique
											(<a href="https://guidgenerator.com/" target="_blank">Online GUID Generator</a>)</li>	
											<pre><code class="hljs">
"appRoles": [
{
  "allowedMemberTypes": ["User"],
  "displayName": "Writer",
  "id": "b421319c-3e45-4685-aaf2-b1282ad05a6f",
  "isEnabled": true,
  "description": "Writers Have the ability to create tasks.",
  "value": "Writer"
}
],
"availableToOtherTenants": false,
											</code></pre>		
										<li>Alter manifest with "Writer" app role". Save</li>
										<li>Assign a user or group to the "Write roles" in "Enterprise apps" - "Users and Groups"</li>			
										<li>Explore the "User information" part of our web app</li>				
										</ul>
									</section>
	
									<section>
										<h3>Accessing 3d party api's protected by oAuth2</h3>
										<ul style="font-size: 70%;">
											<li>Add/Include api resource to scope</li>
											<li>Hit token endpoint to request an access token</li>
											<li>Use access token to access api</li>
											<li>Explore the mail part of our web application (/routes/mail.js)</li>
											<li>Explore Static vs. Dynamic permissions</li>
											<ul>
												<li><a href="https://docs.microsoft.com/nb-no/azure/active-directory/develop/v2-permissions-and-consent" target="_blank">Best practice</a></li>
												<li>Change scope to include <span style="color:blue">
													https://graph.microsoft.com/Contacts.read</span> from code (scope config) and/or "api permissions" in app definition (AD) </li>
												<li>Remember to restart app after changes (and do a new login)</li>
												<li>Add other resources from the MS Graph Explorer and observe consent flow</li>
											</ul>
										</ul>
									</section>
					</section>

<!-- Exercise 6 :  -->	
					<section>
							<section>
								<h1>Exercise 6</h1>
								<h3>Refresh tokens</h3>
							</section>

							<section>
								<h3>Outline</h3>
								<ul>
								<li>What are refresh tokens?</li>
								<li>Framework support for handling refresh</li>
								<li>Prepare environment (ex-6)</li>
								<li>Explore the code</li>
								<li>Config, run and explore</li>
							</ul>
							</section>

							<section>
								<h3>What are refresh tokens?</h3>
								<ul style="font-size: 80%;">
									<li><a href="https://tools.ietf.org/html/rfc6749#section-1.5"
										target="_blank">rfc6749 section 1.5</a>,
										<a href="https://tools.ietf.org/html/rfc6749#section-6"
										target="_blank">rfc6749 section 6 for refresh access token</a>
									</li>
									<li>"Refresh tokens are credentials used to obtain access tokens."</li>
									<li>Are used to get new access token when current one expire</li>
									<li>Are used to get new access token to narrow scope</li>
									<li>Refresh tokens are issued by the authorization server and are never used by resource servers</li>
									<li>Refresh tokens is only issued to secure clients
									</br>(Not supported by implicit flow)</li>
									<li>Refresh tokens can be stored on back-end to perform operations on behalf of user when not logged in</li>
									<li>Refesh tokens are quite often about user experience </br>(log-in experience)</li>
								</ul>
							</section>

							<section>
								<h3>Framework support for handling refresh</h3>
								<ul>
									<li>Framework support for automatic handling of refresh tokens is varying</li>
									<li>Verify support in each framework</li>
									<li><a href="https://docs.microsoft.com/nb-no/azure/active-directory/develop/msal-authentication-flows#how-each-flow-emits-tokens-and-codes"
										target="_blank">Flows</a> that emits refresh tokens in Azure</li>
									<li>Single Page Web applications using MSAL.JS usually do a silent login-and-get-new tokens to the user due to no refresh token</li>
									<li>The framework we use, Passport.js, does not have native support for refresh tokens. So lets add it :)
									</ul>
							</section>

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: blue">./ex-6</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
										</ul>
							</section>

							<section>
									<h3>Explore the code</h3>
									<ul style="font-size:70%">
										<li style="color:blue">config/config.js</li>
											<ul>
												<li>Scope param includes "offline_access" which emits refresh token</li>
												<li>"diffSecondsBeforeRefresh" (ExpireTime - NowTime <= diffSecondsBeforeRefresh)</li>
											</ul>
											<li style="color:blue">src/app.js</li>
											<ul>
												<li>Storing refresh-token in authinfo object</li>
												<li>Middleware (considerRefresh) to determine if we should get new access tokens</li>
											</ul>
											<li style="color:blue">src/authutils.js</li>
											<ul>
												<li>"considerRefresh" function which does the magic</li>
												<li>We refresh based on time (in seconds) before expire</li>
												<li>We could also react to the 401 issued by Azure AD when we try to use and expired access token </li>
												<li>(It's worth knowing that java script stores time in milliseconds while it's seconds int the tokens)</li>
											</ul>
									</ul>
							</section>

							<section>
									<h3>Config, Run and Explore </h3>
									<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 100px;
										right:0px;
										width:20%;
										display:inline-block
									">
									<ul style="font-size: 80%;">
										<li>Verify the AD application object <span style="color:blue">redirect url</span></li>
										<li>Configure environment variables</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore the "user information" part of the web application</li>
										<li>Explore changing the "diffSecondsBeforeRefresh" config and observe token refresh (by expire date and in log)</li>
										<li>Observer that we get a new access token with the refresh, but the "old" one is still valid</li>
									</ul>
							</section>
					</section>
					
<!-- Exercise 7 :  -->	
					<section>
							<section>
								<h1>Exercise 7</h1>
								<h3>Single Page Web Application (SPA)</h3>
								<small>Implicit grant flow </small>
							</section>

							<section>
								<h3>Outline</h3>
								<ul>
									<li>What is a SPA?</li>
									<li>Implicit grant</li>
									<li>Prepare environment (EX-7)</li>
									<li>Explore code</li>
									<li>Config, Run and Explore</li>
									<li>Security considerations</li>
								</ul>
							</section>

							<section>
								<h3>What is a SPA?</h3>
								<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 300px;
										right:0px;
										width:30%;
										display:inline-block
									">
								<ul>
									<li><a href="https://en.wikipedia.org/wiki/Single-page_application"
										target="_blank">SPA</a> = Single Page Application</li>
									<li>Re-Writing DOM rather than refreshing page</li>
									<li>1) Web browser (user agent) only </br>(all communications happens
										</br> in browser, client is in browser)</li>
									<li>2) Hybrid, web communicates </br>to dedicated back-end (client)</br> which then handles external</br> communication</li>
								</ul>
							</section>

		
							<section>
								<h4>oAuth Implicit Grant</h4>
								<small><a href="https://tools.ietf.org/html/rfc6749#section-4.2" target="_blank">rfc6749 #4.2</a></small>
								<pre style="font-size: 30%;">
		+----------+
		| Resource |
		|  Owner   |
		|          |
		+----------+
			 ^
			 |
			(B)
		+----|-----+          Client Identifier     +---------------+
		|         -+----(A)-- & Redirection URI --->|               |
		|  User-   |                                | Authorization |
		|  Agent  -|----(B)-- User authenticates -->|     Server    |
		|          |                                |               |
		|          |<---(C)--- Redirection URI ----<|               |
		|          |          with Access Token     +---------------+
		|          |            in Fragment
		|          |                                +---------------+
		|          |----(D)--- Redirection URI ---->|   Web-Hosted  |
		|          |          without Fragment      |     Client    |
		|          |                                |    Resource   |
		|     (F)  |<---(E)------- Script ---------<|               |
		|          |                                +---------------+
		+-|--------+
		  |    |
		 (A)  (G) Access Token
		  |    |
		  ^    v
		+---------+
		|         |
		|  Client |
		|         |
		+---------+			   			  	
		Client lives inside browser (user agent)						
								</pre>
							</section>
		
				
							<section>
									<h3>OpenID Connect Implicit Flow</h3>
									<table>
										<tr>
											<td><img src="./graphics/export/oauth_implicit_flow.jpg" ></td>
											<td style=" vertical-align: top;">
												<p>-2-</p>
												<span style="font-size: 70%;">
												GET /authorize? </br>
												client_id=client </br>
												&scope=<span style="color:red">openid</span></br>
												&reponse_type=<span style="color:red">id_token</span>+token</br>
												&state=1234</br>
												&<span style="color:red">nonce=a_nonce</span></br>
												&<span style="color:red">redirect_uri=</span></br>
												https://app/callback</span>
												</span>
											</td>
										</tr>
									</table>
							</section>
		
		
							<section>
									<h3>OpenID Connect Implicit Flow</h3>
									<table>
										<tr>
											<td><img src="./graphics/export/oauth_code_flow.jpg" ></td>
											<td style=" vertical-align: top;">
												<p>-3-</p>
												Authentication is handed over to authentication server
											</td>
										</tr>
									</table>
							</section>
		
							<section>
									<h3>OpenID Connect Implicit Flow</h3>
									<table>
										<tr>
											<td><img src="./graphics/export/oauth_implicit_flow.jpg" ></td>
											<td style=" vertical-align: top;">
												<p>-4-</p>
												<span style="font-size: 70%;">
												303 redirect
												https://app/callback? </br>
												
												Fragment: #</br>
												access_token=AT</br>
												expires_in=3600</br>
												token_type=Bearer</br>
												&state=1234</br>
												id_token=IDT</br>		
												</span>
											</td>
										</tr>
									</table>
							</section>
		

							<section>
									<h3>Preparing the environment</h3>
									<ul>
										<li>Navigate to the <span style="color: blue">./ex-7</span> directory</li>
										<li>Install dependencies
											<code class="hljs">$ npm install</code>
										</li>
										</ul>
							</section>

							<section>
								<h3>Explore the code</h3>
								<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 280px;
										right:0px;
										width:20%;
										display:inline-block
									">
								<ul>
									<li>We use an <a href="https://github.com/Azure-Samples/active-directory-javascript-graphapi-v2"
									target="_blank">example</a> from microsoft, calling the graph api from java script</li>
									<li>Our back-end only serves the static web pages</li>
									<ul>
										<li><span style="color:blue">server.js</span> serves the static web pages</li>
									</ul>
									<li>The application lives in the browser</li>
									<ul>
										<li<span style="color:blue">JavaScriptSPA/index.html</span></li<span>
									</ul>
								</ul>
							</section>

							<section>
								<h3>Config, Run and Explore</h3>
								<ul style="font-size: 80%;">
										<li>Update configuration in <span style="color:blue">javaScriptSPA/index.html:msalConfig</span> (clientid, authority)</li>
										<li>Configure AD app object (Azure AD)</li>
											<ul>
												<li>Redirect URI: http://localhost</li>
												<li>Authentication:Advances Setting:Implicit grant - allow access token and ID tokens</li>	
											</ul>
										<li>Configure environment back-end variables (PORT)</li>
										<li>Run web application
											<code class="hljs">$ npm start</code>
										</li>
										<li>Explore SPA Client (Browser, Developer Mode)</li>
										<ul>
											<li>Network flow to graph api - headers</li>
											<li>Cookies</li>
											<li>Local storage</li>
										</ul>
									</ul>
							</section>

							<section>
									<h3>Security considerations</h3>
									<ul style="font-size: 80%;">
										<li>It's a public client!</li>
										<li>Implicit flow is less secure than code grant</li>
										<li>The redirect GET REQUEST exposes the AccessToken</li>
										<li>Information - like access tokens are available to "everyone" using the browser</li>
										<li><span style="color:red">Good practice</span>: 
											Follow advice in OWASP Top 10 for Web application security ( 
											<a href="https://www.owasp.org/images/7/72/OWASP_Top_10-2017_%28en%29.pdf.pdf" target="_blank">PDF</a>)</li>
											<li><span style="color:red">Good practice</span>: Always use HTTPS</li>
											<li><span style="color:red">Good practice</span>: Use Content Security Policy</li>
											<li><span style="color:red">Good practice</span>: Go with auth code grant flow if you can :)</li>
											<li><span style="color:red">Good advice</span>: 
												Monitor support for PKCE in MSAL.js ( 
												<a href="https://github.com/AzureAD/microsoft-authentication-library-for-js/wiki" target="_blank">April 2020, Beta release of MSAL 2.0.0</a>)</li>	
										</ul>
								</section>
					</section>

<!-- Exercise 8 :  -->	
					<section>
							<section>
								<h1>Exercise 8</h1>
								<h3>Protecting web api's</h3>
								</br><small>AD App, Token validation</small>
								</br><small>Azure API GW - APIM</small>
							</section>

							<section>
								<h3>Outline</h3>
								<ul>
									<li>The scenario</li>
									<li>Add AD Application Object for API</li>
									<li>Explore and config the SPA code</li>
									<li>Explore and config the API code</li>
									<li>Run and Explore</li>
									<li>Security considerations</li>
								</ul>
							</section>

							<section>
								<h3>The Scenario</h3>
								<img src="./graphics/export/actors.jpg" 
									style="
										position: absolute;
										top: 0px;
										right:0px;
										width:20%;
										display:inline-block
									">
								<ul>
									<li>Two components</li>
									<ul>
										<li>Single Page Web Application (from prev. exercise)</li>
										<li>API which echoes time</li>
									</ul>
									<li>New button in SPA to "Echo" api</li>
									<li>SPA sends request to API with access token as a bearer token</li>
									<li>API validates token and reponds with time if everything is ok</li>
								</ul>
							</section>

							<section>
								<h3>Adding Azure AD application object for API</h3>
								<ul style="font-size: 80%;">
									<li>Follow procedure in <a href="#/7/2" target="_blank">earlier exercise</a> to register API </li>
									<li>Activate "Application developer role" in "Privileged Identiy Management"</li>
									<li><span style="color:red">Name</span>: (inital)-(aa-api) or something else</li>
									<li><span style="color:red">Type</span>: Single tenant</li>
									<li>Select "Expose an API" (app config)</li>
									<ul>
										<li>Add scope (accept suggested App ID URI)</li>
										<li>Scope name: Echo.Read</li>
										<li>Who can consent: Admins and Users (Add relevant text to descriptions)</li>
										<li>State: Enabled</li>
										<li>Remove "default" API permissions from API object (user.read)</li>
									</ul>
									</li>
								</ul>
							</section>

							<section>
								<h3>Explore and config the SPA code</h3>
								<ul style="font-size: 90%;">
									<li>Navigate to the <span style="color: blue">./ex-8/spa</span> directory</li>
									<li>Install dependencies <code class="hljs">$ npm install</code></li>
									<li>Update config in "JavaScriptSPA/index.html</li>	
									<ul>
										<li>msalConfig: clientId, authority(tenant id) (for SPA AD App)</li>
										<li>getEcho():requestEchoObj:scope (api://..../Echo.Read)</li>
										<li>getEcho(): Url to API (http://localhost:3100)</li>
									</ul>
									<li>The getEcho function do</li>
									<ul>
										<li>Request an access token to access the Echo API</li>
										<li>Call Echo with access token and then displays response</li>
									</ul>
								</ul>
							</section>


							<section>
									<h3>Explore and config the API code</h3>
									<ul style="font-size:60%">
										<li>Navigate to the <span style="color: blue">./ex-8/api</span> directory</li>
										<li>Install dependencies <code class="hljs">$ npm install</code></li>
										<li>Update config in "bin/www (the port if needed)</li>	
										<li>Update config in "routes/index.js</li>
										<ul>
											<li>validateOptions: audience (the api app URI)</li>
											<li>validateOptions: issuer (the tenant id)</li>
										</ul>
										<li>Update config in "app.js" (corsOptions, will only accept requests from localhost. Must be changed if the SPA is moved)</li>
										<li>Code: "routes/index.js"</li>
										<ul>
											<li>Gets the api request, using 
												<a href="https://github.com/auth0/node-jsonwebtoken"
												target="_blank">library</a> to validate token</li>
											<li>"validateOptions" defines what will be validated</li>
											<li>Uses "well known endpoints" of API object to find keys++</li>
										</ul>
										<li>Code: "./app.js"</li>
										<ul>
											<li>The API middleware layer (Express)</li>
											<li>Define CORS headers using a <a href="https://github.com/expressjs/cors"
											target="_blank">library</a></li>
										</ul>
									</ul>
								</section>

								<section>
									<h3>Run and explore scenario</h3>
									<ul style="font-size: 90%;">
										<li>Use two terminal sessions - SPA, API</li>
										<li>Navigate to the <span style="color: blue">./ex-8/api</span> and do
											<code class="hljs">$ npm start</code></li>
										<li>Navigate to the <span style="color: blue">./ex-8/spa</span> and do
											<code class="hljs">$ npm start</code></li>
										<li>Explore the new "Echo" functionallity</li>
										<li>Alter CORS headers and observe effect (in SPA - Dev mode</li>
										<li>Alter token validation options in API and observe effect</li>
										<li>Alter scope for Api in SPA and observe effect</li>
									</ul>
									
								</section>

								<section>
									<h3>Alternative solutions for chaining api</h3>
									</br>
									<ul>
										<li>The <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow"
											target="_blank">On-Behalf-Of</a> flow in the MS Identity Platform</a>
										</li>
									</ul>
								</section>
								<section>
									<h3>Security considerations</h3>
									<ul>
										<li>Use libraries to do token validation</li>
										<li>"Trust but verify" vs. "No trust"</li>
										<li><span style="color:red">Good practice</span>: Consider placing your API behind and api gateway (such as 
											<a href="https://azure.microsoft.com/en-us/services/api-management/"
											target="_blank">APIM</a>)</li>
										<li><span style="color:red">Good practice</span>: Consult the  
											<a href="https://www.owasp.org/index.php/OWASP_API_Security_Project"
											target="_blank">OWASP API Security Project</a>)</li>	
											
									</ul>
								</section>

					</section>

					

<!-- Exercise 9 :  -->	

					<section>
						<section>
							<h3>Exercise 9</h3>
							<h2>Deploying to the Cloud</h2>
							<small>Radix for the win</small>
						</section>

						<section>
							<h3>The code</h3>
							<ul style="font-size: 80%;">
								<li>Fork from code in ex-4</li>
								<li>Important changes going from local to the cloud</li>
								<ul>
									<li>The deployment environment becomes dynamic. Potential specific to the cloud provider technology.
									<li>We use Docker to be a bit more "multi cloud" ready</li>
									<li>Important URLs, like redirect_url, becomes dynamic. Added some logic to handle this for Radix </br>(in <span style="color: red">./src/app.js , ./src/authutils.js</span>)</li>
									<li>Still keeping secrets outside code. Storing the CLIENT_SECRET as a secret in Radix</li>
								<ul>
							</ul>
						</section>

						<section>
							<h2>Tasks</h2>
							<ul>
								<li>Fork the project at <span style="color:red">https://github.com/larskaare/sMailandStuff</span>
								</br> to your own user on github.com</li>
								<li>Use the instructions in the README.md to configure and run the application locally</li>
								<li>Deploy to the cloud using Radix. A good place to start would be <a href="https://www.radix.equinor.com" target="_blank">The Radix Getting Started</a></li>
							</ul>
						</section>
						<section>
							<h2>Traps ...</h2>
							<ul>
								<li>The app name in radixconfig</li>
								<li>Remove SNYK token from radixconfig (or define value in console)</li>
								<li>Update redirect URL in app registration</li>
								<li>Update CLIENTID in radixconfig</li>
							</ul>
						</section>
					</section>


					<section>
						<section>
							<h1>Security Resources</h1>
						</section>
						<section>
							<h3>Links to relevant security resources</h3>
							<ul>
								<li><a href="https://tools.ietf.org/html/rfc6819" target="_blank">oAuth2 Threat Model and Security Considerations</a></li>
								<li><a href="https://tools.ietf.org/html/draft-ietf-oauth-security-topics" target="_blank">OAuth Security Topics</a></li>
								<li><a href="https://owasp.org/www-project-top-ten/" target="_blank">OWASP Top-10 Project</a></li>
								<li><a href="https://owasp.org/www-project-api-security/" target="_blank">OWASP API Security Project</a></li>
							
							</ul>
						</section>

				</section>


				<section>
					<h3>Going deeper into the A&A topic ...</h3>
					<img src="./graphics/oauth2inaction.jpeg" width="40%">
				</section>


					<section>
							<section>
								<h1>Clean-Up</h1>
								<ul>
									<li>Clean-up in Azure AD App Registration</li>
									<li>Clean-up in Radix - remove app after usage</li>
								</ul>
							</section>
					</section>

					<section>
						<section>
							<h1>Thanx You!</h1>
							<ul>
								<li>Join <a href="https://equinor.slack.com/archives/CMM6FSW5V" target="_blank">#appsec</a> on Slack</li>
								<li>Continue discussion on A&A and other application security related topics</li>
							</ul>
						</section>
				</section>

			</div>
		</div>

		
		<script src="dist/reveal.js"></script>
		<!-- <script src="plugin/notes/notes.js"></script> -->
		<!-- <script src="plugin/markdown/markdown.js"></script> -->
		<script src="plugin/highlight/highlight.js"></script>
		<script src="plugin/zoom/zoom.js"></script>
		<script src="plugin/search/search.js"></script>

		<script>

			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				center: true,
				hash: true,
				slideNumber: true,
				hash: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// More info https://github.com/hakimel/reveal.js#dependencies
				// dependencies: [
				// 	{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
				// 	{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
				// 	{ src: 'plugin/highlight/highlight.js', async: true },
				// 	{ src: 'plugin/search/search.js', async: true },
				// 	{ src: 'plugin/zoom-js/zoom.js', async: true },
				// 	{ src: 'plugin/notes/notes.js', async: true }
				// ]
			

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealHighlight, RevealZoom, RevealSearch ]
			});

		</script>

	</body>
</html>
